<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jace Multisend - X Layer</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="https://woofingjace.com/images/jace.png" type="image/x-icon">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background: #121212; color: #E6E6E6; padding: 15px; min-height: 100vh; line-height: 1.6; }
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; background: #1A1A1A; border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5); }
        h1 { text-align: center; color: #00BFA5; font-size: clamp(1.6em, 4vw, 2em); margin-bottom: 20px; font-weight: 700; text-transform: uppercase; }
        .section { background: #222222; padding: 15px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #00BFA5; }
        h2 { color: #00BFA5; font-size: clamp(1em, 3vw, 1.3em); margin-bottom: 10px; font-weight: 600; }
        .button { background: #00BFA5; color: #121212; padding: 8px 16px; border: none; border-radius: 6px; font-weight: 600; font-size: 0.9em; cursor: pointer; transition: background 0.3s ease, transform 0.2s ease; margin: 5px 0; width: 100%; max-width: 180px; }
        .button:hover { background: #009688; transform: translateY(-2px); }
        .button:disabled { background: #444; color: #777; cursor: not-allowed; }
        input, textarea, select { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #00BFA5; border-radius: 6px; background: #2A2A2A; color: #E6E6E6; font-size: 0.9em; box-sizing: border-box; }
        textarea { min-height: 100px; resize: vertical; }
        input::placeholder, textarea::placeholder { color: #666; }
        .status { margin-top: 8px; font-size: 0.85em; color: #00BFA5; }
        .error { color: #FF5252; font-weight: 600; }
        .wallet-info { color: #00BFA5; font-weight: 600; word-break: break-all; }
        .token-table { width: 100%; border-collapse: collapse; margin-top: 10px; background: #2A2A2A; }
        .token-table th, .token-table td { padding: 8px; text-align: left; border-bottom: 1px solid #333; font-size: 0.85em; }
        .token-table th { background: #2A2A2A; color: #00BFA5; font-weight: 600; }
        .token-img { width: 18px; height: 18px; vertical-align: middle; margin-right: 5px; }
        .loading { opacity: 0.7; pointer-events: none; }
        .footer { text-align: center; margin-top: 20px; font-size: 0.8em; color: #666; }
        .footer a { color: #00BFA5; text-decoration: none; }
        .footer a:hover { text-decoration: underline; }
        .how-it-works { background: #222222; padding: 15px; border-radius: 8px; border: 1px solid #00BFA5; margin-top: 15px; }
        .how-it-works ul { list-style-type: disc; padding-left: 20px; margin-top: 8px; }
        .how-it-works li { margin-bottom: 8px; font-size: 0.85em; }
        .how-it-works .highlight { color: #00BFA5; font-weight: 600; }
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .section, .how-it-works { padding: 10px; }
            .button { padding: 8px; max-width: 100%; }
            .token-table { overflow-x: auto; white-space: nowrap; }
            .token-table th, .token-table td { font-size: 0.8em; padding: 6px; }
            .token-table thead, .token-table tbody, .token-table tr, .token-table td, .token-table th { display: table-cell; }
            .how-it-works ul { padding-left: 15px; }
            .how-it-works li { font-size: 0.8em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Jace Multisend</h1>
        <div class="section">
            <h2>Connect to X Layer</h2>
            <button id="connectButton" class="button">Connect Wallet</button>
            <p>Wallet: <span id="walletAddress" class="wallet-info">Not connected</span></p>
            <div id="networkStatus" class="status">Click to connect...</div>
        </div>
        <div class="section" id="multisendSection">
            <h2>Batch Transfer</h2>
            <select id="transferType" onchange="toggleTokenAddress()">
                <option value="OKB">OKB (X Layer Mainnet Coin)</option>
                <option value="Token">Token</option>
            </select>
            <input type="text" id="tokenAddress" placeholder="Token Contract Address (e.g., 0x...)" style="display: none;">
            <textarea id="transferList" placeholder="Enter address,amount per line (e.g.,\n0xfb10e2b3f29931f8372680877f1e4b3a139d9fa3,10000\n0xb82b803105107dd873baa9e61435d4710b531d6b,11000)"></textarea>
            <button id="sendBatch" class="button" disabled>Send Batch Transfer</button>
            <button id="approveToken" class="button" style="display: none; margin-top: 10px;">Approve Token</button>
            <div id="multisendStatus" class="status"></div>
            <table class="token-table">
                <thead>
                    <tr>
                        <th>Coin</th>
                        <th>Address</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody id="transferPreview"></tbody>
            </table>
        </div>
        <div class="how-it-works">
            <h2>How It Works?</h2>
            <p>Send OKB or tokens to multiple addresses on X Layer with Jace Multisend:</p>
            <ul>
                <li><strong>Connect Your Wallet</strong>: Use MetaMask to connect to X Layer (chain ID: 196). Ensure you have enough <span class="highlight">OKB</span> for gas fees.</li>
                <li><strong>Select Transfer Type</strong>: Choose <span class="highlight">OKB</span> for mainnet coin or <span class="highlight">Token</span> for ERC20 tokens.</li>
                <li><strong>Enter Token Address</strong>: Input a valid ERC20 token contract address on X Layer.</li>
                <li><strong>Input Addresses & Amounts</strong>: Enter one address and amount per line (e.g., <span class="highlight">0xfb10e2b3f29931f8372680877f1e4b3a139d9fa3,10000</span>). Supports up to 200 addresses.</li>
                <li><strong>Approve Token</strong>: For token transfers, approve the contract to spend your tokens.</li>
                <li><strong>Send Batch</strong>: Execute the batch transfer.</li>
            </ul>
        </div>
        <div class="footer">
            Powered by <a href="https://www.okx.com/web3/explorer/xlayer" target="_blank">X Layer</a> | Jace Multisend Â© 2025
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.0/dist/web3.min.js"></script>
    <script>
        let web3, accounts, multisendContract;
        const multisendAddress = "0xa0efAC6b1096a4D2C40BFb2a32dC2AF71a45A9F8";
        const OKB_LOGO = "https://static.oklink.com/cdn/assets/imgs/243/230501A8E74482AB.png";

        const multisendABI = [
            { "inputs": [{"internalType":"address","name":"_token","type":"address"},{"internalType":"address[]","name":"_targets","type":"address[]"},{"internalType":"uint[]","name":"_amounts","type":"uint[]"}],"name":"multisendToken","outputs":[],"stateMutability":"nonpayable","type":"function"},
            { "inputs": [{"internalType":"address[]","name":"_targets","type":"address[]"},{"internalType":"uint[]","name":"_amounts","type":"uint[]"}],"name":"multisendEth","outputs":[],"stateMutability":"payable","type":"function"},
            { "inputs": [{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},
            { "inputs": [{"internalType":"address","name":"_token","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"withdrawToken","outputs":[],"stateMutability":"nonpayable","type":"function"}
        ];

        const tokenABI = [
            { "inputs": [{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
            { "inputs": [{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            { "inputs": [],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"}
        ];

        const xLayer = { chainId: 196, name: 'X Layer mainnet', rpcUrl: 'https://rpc.xlayer.tech' };

        async function connectWallet() {
            const status = document.getElementById('networkStatus');
            const sendButton = document.getElementById('sendBatch');
            try {
                if (!window.ethereum) throw new Error("No wallet detected. Install MetaMask.");
                status.textContent = "Connecting...";
                web3 = new Web3(window.ethereum);
                accounts = await web3.eth.requestAccounts();
                const chainId = await web3.eth.getChainId();
                if (chainId !== 196) {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: '0xc4' }],
                    }).catch(() => {
                        window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: '0xc4',
                                chainName: xLayer.name,
                                rpcUrls: [xLayer.rpcUrl],
                                nativeCurrency: { name: 'OKB', symbol: 'OKB', decimals: 18 },
                            }],
                        });
                    });
                }
                document.getElementById('walletAddress').textContent = `${accounts[0].slice(0, 6)}...${accounts[0].slice(-4)}`;
                multisendContract = new web3.eth.Contract(multisendABI, multisendAddress);
                status.textContent = "Connected to X Layer";
                sendButton.disabled = false;
                console.log("Wallet connected at", new Date().toLocaleString("en-US", { timeZone: "Asia/Hong_Kong" }));
            } catch (error) {
                console.error("Connect error:", error);
                status.textContent = `Error: ${error.message}`;
                sendButton.disabled = true;
            }
        }

        function toggleTokenAddress() {
            const transferType = document.getElementById('transferType').value;
            const tokenAddressInput = document.getElementById('tokenAddress');
            const approveButton = document.getElementById('approveToken');
            tokenAddressInput.style.display = transferType === 'Token' ? 'block' : 'none';
            approveButton.style.display = transferType === 'Token' ? 'block' : 'none';
            parseTransferList();
        }

        async function parseTransferList() {
            const transferList = document.getElementById('transferList').value.trim();
            const lines = transferList.split('\n').map(line => line.trim()).filter(line => line);
            const transfers = [];
            const previewBody = document.getElementById('transferPreview');
            const status = document.getElementById('multisendStatus');
            previewBody.innerHTML = '';

            if (lines.length > 200) {
                status.textContent = "Error: Maximum 200 addresses allowed";
                return null;
            }

            for (const line of lines) {
                const [address, amountStr] = line.split(',').map(item => item.trim());
                console.log("Parsing line:", line, "->", { address, amountStr });
                if (!address || !web3.utils.isAddress(address)) {
                    status.textContent = `Error: Invalid address in line: ${line}`;
                    return null;
                }
                const amount = parseFloat(amountStr);
                if (isNaN(amount) || amount <= 0) {
                    status.textContent = `Error: Invalid amount in line: ${line}`;
                    return null;
                }
                transfers.push({ address, amount: web3.utils.toWei(amountStr, 'ether') });
                const row = document.createElement('tr');
                row.innerHTML = `<td><img src="${OKB_LOGO}" class="token-img">Token</td><td>${address.slice(0, 6)}...${address.slice(-4)}</td><td>${amount}</td>`;
                previewBody.appendChild(row);
            }
            status.textContent = transfers.length > 0 ? `Ready to send to ${transfers.length} addresses` : 'Enter valid transfers';
            return { transfers };
        }

        async function approveToken() {
            const status = document.getElementById('multisendStatus');
            const tokenAddress = document.getElementById('tokenAddress').value.trim();
            if (!web3.utils.isAddress(tokenAddress)) {
                status.textContent = "Error: Invalid token address format";
                return;
            }
            try {
                const tokenContract = new web3.eth.Contract(tokenABI, tokenAddress);
                status.textContent = "Approving token...";
                await tokenContract.methods.approve(multisendAddress, web3.utils.toWei('1000000000', 'ether')).send({ from: accounts[0] });
                status.textContent = "Token approved successfully!";
                console.log("Token approved at", new Date().toLocaleString("en-US", { timeZone: "Asia/Hong_Kong" }));
            } catch (error) {
                console.error("Approve error:", error);
                status.textContent = `Error: ${error.message}`;
            }
        }

        async function sendBatchTransfer() {
            const section = document.getElementById('multisendSection');
            const status = document.getElementById('multisendStatus');
            const sendButton = document.getElementById('sendBatch');
            console.log("Send button clicked at", new Date().toLocaleString("en-US", { timeZone: "Asia/Hong_Kong" }));

            if (!web3 || !accounts) {
                status.textContent = "Error: Wallet not connected. Please connect first.";
                sendButton.disabled = false;
                return;
            }

            const parsed = await parseTransferList();
            if (!parsed) {
                status.textContent = status.textContent || "Error: Please fix the input.";
                sendButton.disabled = false;
                return;
            }
            const { transfers } = parsed;

            try {
                section.classList.add('loading');
                sendButton.disabled = true;
                status.textContent = "Sending batch...";
                const targets = transfers.map(t => t.address);
                const amounts = transfers.map(t => t.amount);
                const transferType = document.getElementById('transferType').value;

                if (transferType === 'Token') {
                    const tokenAddress = document.getElementById('tokenAddress').value.trim();
                    await multisendContract.methods.multisendToken(tokenAddress, targets, amounts).send({ from: accounts[0] });
                } else {
                    await multisendContract.methods.multisendEth(targets, amounts).send({ from: accounts[0], value: web3.utils.toWei('0.01', 'ether') }); // Placeholder value
                }
                status.textContent = "Batch transfer successful!";
                document.getElementById('transferList').value = '';
                document.getElementById('transferPreview').innerHTML = '';
            } catch (error) {
                console.error("Send error:", error);
                status.textContent = `Error: ${error.message}. Check console for details.`;
                sendButton.disabled = false;
            } finally {
                section.classList.remove('loading');
                sendButton.disabled = false;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const connectButton = document.getElementById('connectButton');
            const sendButton = document.getElementById('sendBatch');
            const approveButton = document.getElementById('approveToken');
            const validateButton = document.getElementById('validateToken');
            if (connectButton && sendButton && approveButton) {
                connectButton.addEventListener('click', connectWallet);
                sendButton.addEventListener('click', sendBatchTransfer);
                approveButton.addEventListener('click', approveToken);
                console.log("Event listeners attached at", new Date().toLocaleString("en-US", { timeZone: "Asia/Hong_Kong" }));
            } else {
                console.error("Buttons not found in DOM:", { connectButton, sendButton, approveButton });
            }
            document.getElementById('transferList').addEventListener('input', parseTransferList);
            document.getElementById('tokenAddress').addEventListener('input', parseTransferList);
            document.getElementById('sendBatch').disabled = true;
        });

        window.addEventListener('load', () => {
            if (!window.location.protocol.startsWith('http')) {
                document.getElementById('networkStatus').textContent = 'Run via local server (e.g., npx serve)';
            } else if (!window.ethereum) {
                document.getElementById('networkStatus').textContent = 'Install MetaMask';
            }
        });
    </script>
</body>
</html>
