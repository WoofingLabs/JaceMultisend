<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jace Multisend - X Layer</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="https://woofingjace.com/images/jace.png" type="image/x-icon">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Inter', sans-serif; 
            background: #121212; 
            color: #E6E6E6; 
            padding: 15px; 
            min-height: 100vh; 
            line-height: 1.6; 
        }
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #1A1A1A; 
            border-radius: 10px; 
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5); 
        }
        h1 { 
            text-align: center; 
            color: #00BFA5; 
            font-size: clamp(1.6em, 4vw, 2em); 
            margin-bottom: 20px; 
            font-weight: 700; 
            text-transform: uppercase; 
        }
        .section { 
            background: #222222; 
            padding: 15px; 
            margin-bottom: 15px; 
            border-radius: 8px; 
            border: 1px solid #00BFA5; 
        }
        h2 { 
            color: #00BFA5; 
            font-size: clamp(1em, 3vw, 1.3em); 
            margin-bottom: 10px; 
            font-weight: 600; 
        }
        .button { 
            background: #00BFA5; 
            color: #121212; 
            padding: 8px 16px; 
            border: none; 
            border-radius: 6px; 
            font-weight: 600; 
            font-size: 0.9em; 
            cursor: pointer; 
            transition: background 0.3s ease, transform 0.2s ease; 
            margin: 5px 0; 
            width: 100%; 
            max-width: 180px; 
        }
        .button:hover { 
            background: #009688; 
            transform: translateY(-2px); 
        }
        .button:disabled { 
            background: #444; 
            color: #777; 
            cursor: not-allowed; 
        }
        input, textarea, select { 
            width: 100%; 
            padding: 10px; 
            margin: 8px 0; 
            border: 1px solid #00BFA5; 
            border-radius: 6px; 
            background: #2A2A2A; 
            color: #E6E6E6; 
            font-size: 0.9em; 
            box-sizing: border-box; 
        }
        textarea { 
            min-height: 100px; 
            resize: vertical; 
        }
        input::placeholder, textarea::placeholder { 
            color: #666; 
        }
        .status { 
            margin-top: 8px; 
            font-size: 0.85em; 
            color: #00BFA5; 
        }
        .error { 
            color: #FF5252; 
            font-weight: 600; 
        }
        .wallet-info { 
            color: #00BFA5; 
            font-weight: 600; 
            word-break: break-all; 
        }
        .token-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 10px; 
            background: #2A2A2A; 
        }
        .token-table th, .token-table td { 
            padding: 8px; 
            text-align: left; 
            border-bottom: 1px solid #333; 
            font-size: 0.85em; 
        }
        .token-table th { 
            background: #2A2A2A; 
            color: #00BFA5; 
            font-weight: 600; 
        }
        .token-img { 
            width: 18px; 
            height: 18px; 
            vertical-align: middle; 
            margin-right: 5px; 
        }
        .loading { 
            opacity: 0.7; 
            pointer-events: none; 
        }
        .footer { 
            text-align: center; 
            margin-top: 20px; 
            font-size: 0.8em; 
            color: #666; 
        }
        .footer a { 
            color: #00BFA5; 
            text-decoration: none; 
        }
        .footer a:hover { 
            text-decoration: underline; 
        }
        .how-it-works { 
            background: #222222; 
            padding: 15px; 
            border-radius: 8px; 
            border: 1px solid #00BFA5; 
            margin-top: 15px; 
        }
        .how-it-works ul { 
            list-style-type: disc; 
            padding-left: 20px; 
            margin-top: 8px; 
        }
        .how-it-works li { 
            margin-bottom: 8px; 
            font-size: 0.85em; 
        }
        .how-it-works .highlight { 
            color: #00BFA5; 
            font-weight: 600; 
        }
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .section, .how-it-works { padding: 10px; }
            .button { padding: 8px; max-width: 100%; }
            .token-table { overflow-x: auto; white-space: nowrap; }
            .token-table th, .token-table td { font-size: 0.8em; padding: 6px; }
            .token-table thead, .token-table tbody, .token-table tr, .token-table td, .token-table th { 
                display: table-cell; 
            }
            .how-it-works ul { padding-left: 15px; }
            .how-it-works li { font-size: 0.8em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Jace Multisend</h1>
        <div class="section">
            <h2>Connect to X Layer</h2>
            <button id="connectButton" class="button">Connect Wallet</button>
            <p>Wallet: <span id="walletAddress" class="wallet-info">Not connected</span></p>
            <div id="networkStatus" class="status">Click to connect...</div>
        </div>
        <div class="section" id="multisendSection">
            <h2>Batch Transfer</h2>
            <select id="transferType" onchange="toggleTokenAddress()">
                <option value="OKB">OKB (X Layer Mainnet Coin)</option>
                <option value="Token">Token</option>
            </select>
            <input type="text" id="tokenAddress" placeholder="Token Address (e.g., 0x...)" style="display: none;">
            <textarea id="transferList" placeholder="Enter addresses and amounts (e.g., 0x123...abc,10000\n0x456...def,11000)"></textarea>
            <button id="sendBatch" class="button" disabled>Send Batch Transfer</button>
            <div id="multisendStatus" class="status"></div>
            <table class="token-table">
                <thead>
                    <tr>
                        <th>Coin</th>
                        <th>Address</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody id="transferPreview"></tbody>
            </table>
        </div>
        <div class="how-it-works">
            <h2>How It Works?</h2>
            <p>Send OKB or tokens to multiple addresses on X Layer with Jace Multisend:</p>
            <ul>
                <li><strong>Connect Your Wallet</strong>: Use MetaMask to connect to X Layer (chain ID: 196). Ensure you have enough <span class="highlight">OKB</span> for gas fees.</li>
                <li><strong>Select Transfer Type</strong>: Choose <span class="highlight">OKB</span> for mainnet coin or <span class="highlight">Token</span> for ERC20 tokens.</li>
                <li><strong>Enter Token Address</strong>: Input a valid ERC20 token contract address on X Layer.</li>
                <li><strong>Input Addresses & Amounts</strong>: Enter one address and amount per line (e.g., <span class="highlight">0x...address,10000</span>). Supports up to 200 addresses.</li>
                <li><strong>Send Batch</strong>: Approve tokens if needed, then execute the transfer.</li>
            </ul>
        </div>
        <div class="footer">
            Powered by <a href="https://www.okx.com/web3/explorer/xlayer" target="_blank">X Layer</a> | Jace Multisend Â© 2025
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.0/dist/web3.min.js"></script>
    <script>
        let web3, accounts, multisendContract;
        const multisendAddress = "0xa0efAC6b1096a4D2C40BFb2a32dC2AF71a45A9F8";
        const OKB_LOGO = "https://static.oklink.com/cdn/assets/imgs/243/230501A8E74482AB.png";
        const MAX_UINT256 = '0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff';

        const multisendABI = [
            { "inputs": [{"internalType":"address","name":"_token","type":"address"},{"internalType":"address[]","name":"_targets","type":"address[]"},{"internalType":"uint[]","name":"_amounts","type":"uint[]"}],"name":"multisendToken","outputs":[],"stateMutability":"nonpayable","type":"function"},
            { "inputs": [{"internalType":"address[]","name":"_targets","type":"address[]"},{"internalType":"uint[]","name":"_amounts","type":"uint[]"}],"name":"multisendEth","outputs":[],"stateMutability":"payable","type":"function"},
            { "inputs": [{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},
            { "inputs": [{"internalType":"address","name":"_token","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"withdrawToken","outputs":[],"stateMutability":"nonpayable","type":"function"}
        ];

        const tokenABI = [
            { "inputs": [{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
            { "inputs": [{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            { "inputs": [],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"}
        ];

        const xLayer = { chainId: 196, name: 'X Layer mainnet', explorerUrl: 'https://www.okx.com/web3/explorer/xlayer', rpcUrl: 'https://rpc.xlayer.tech' };

        async function connectWallet() {
            const status = document.getElementById('networkStatus');
            const sendButton = document.getElementById('sendBatch');
            try {
                if (!window.ethereum) throw new Error("No wallet detected. Install MetaMask.");
                status.textContent = "Connecting...";
                web3 = new Web3(window.ethereum);
                accounts = await web3.eth.requestAccounts();
                const chainId = await web3.eth.getChainId();
                if (chainId !== 196) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0xc4' }],
                        });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: '0xc4',
                                    chainName: xLayer.name,
                                    rpcUrls: [xLayer.rpcUrl],
                                    nativeCurrency: { name: 'OKB', symbol: 'OKB', decimals: 18 },
                                    blockExplorerUrls: [xLayer.explorerUrl],
                                }],
                            });
                        } else {
                            throw switchError;
                        }
                    }
                }
                document.getElementById('walletAddress').textContent = `${accounts[0].slice(0, 6)}...${accounts[0].slice(-4)}`;
                multisendContract = new web3.eth.Contract(multisendABI, multisendAddress);
                status.textContent = "Connected to X Layer";
                sendButton.disabled = false;
                console.log("Wallet connected at", new Date().toLocaleString("en-US", { timeZone: "Asia/Hong_Kong" }));
            } catch (error) {
                console.error("Connect error:", error);
                status.textContent = `Error: ${error.message}`;
                sendButton.disabled = true;
            }
        }

        function toggleTokenAddress() {
            const transferType = document.getElementById('transferType').value;
            const tokenAddressInput = document.getElementById('tokenAddress');
            tokenAddressInput.style.display = transferType === 'Token' ? 'block' : 'none';
            parseTransferList();
        }

        async function parseTransferList() {
            const transferList = document.getElementById('transferList').value.trim();
            const transferType = document.getElementById('transferType').value;
            const lines = transferList.split('\n').map(line => line.trim()).filter(line => line);
            const transfers = [];
            const previewBody = document.getElementById('transferPreview');
            const status = document.getElementById('multisendStatus');
            previewBody.innerHTML = '';

            if (lines.length > 200) {
                status.textContent = "Error: Maximum 200 addresses allowed";
                return null;
            }

            let totalAmount = web3.utils.toBN(0);
            let symbol = 'OKB';
            let logo = OKB_LOGO;
            let decimals = 18;

            if (transferType === 'Token') {
                const tokenAddress = document.getElementById('tokenAddress').value.trim();
                console.log("Validating token address:", tokenAddress);
                if (!web3.utils.isAddress(tokenAddress)) {
                    status.textContent = "Error: Invalid address format (e.g., missing '0x' or wrong length)";
                    console.log("Address format invalid");
                    return null;
                }
                if (web3 && accounts) {
                    try {
                        const code = await web3.eth.getCode(tokenAddress).catch(err => {
                            console.error("getCode failed:", err);
                            return '0x'; // Fallback to treat as non-contract
                        });
                        if (code === '0x') {
                            status.textContent = "Error: Token address is not a contract";
                            console.log("Not a contract");
                            return null;
                        }
                        const tokenContract = new web3.eth.Contract(tokenABI, tokenAddress);
                        decimals = await tokenContract.methods.decimals().call().catch(err => {
                            console.error("decimals call failed:", err);
                            return 18; // Fallback to 18 decimals
                        });
                        symbol = 'Token';
                        logo = `https://ui-avatars.com/api/?name=T&background=00BFA5&color=121212&size=18`;
                        console.log("Token validated, decimals:", decimals);
                    } catch (error) {
                        status.textContent = `Error: Failed to validate token: ${error.message}`;
                        console.log("Validation error:", error);
                        return null;
                    }
                }
            }

            for (const line of lines) {
                const [address, amountStr] = line.split(',').map(item => item.trim());
                if (!web3.utils.isAddress(address)) {
                    status.textContent = `Error: Invalid address: ${address}`;
                    return null;
                }
                const amount = parseFloat(amountStr);
                if (isNaN(amount) || amount <= 0) {
                    status.textContent = `Error: Invalid amount for address ${address}: ${amountStr}`;
                    return null;
                }
                const amountWei = web3.utils.toWei(amountStr, decimals === 18 ? 'ether' : { unit: 'wei', decimals });
                transfers.push({ address, amount: amountWei });
                const row = document.createElement('tr');
                row.innerHTML = `<td><img src="${logo}" class="token-img">${symbol}</td><td>${address.slice(0, 6)}...${address.slice(-4)}</td><td>${amount}</td>`;
                previewBody.appendChild(row);
                totalAmount = totalAmount.add(web3.utils.toBN(amountWei));
            }
            status.textContent = transfers.length > 0 ? `Ready to send to ${transfers.length} addresses` : '';
            return { transfers, totalAmount, decimals };
        }

        async function sendBatchTransfer() {
            const section = document.getElementById('multisendSection');
            const status = document.getElementById('multisendStatus');
            const sendButton = document.getElementById('sendBatch');
            console.log("Send button clicked at", new Date().toLocaleString("en-US", { timeZone: "Asia/Hong_Kong" }));

            if (!web3 || !accounts) {
                status.textContent = "Error: Wallet not connected. Please connect first.";
                console.log("No web3 or accounts:", { web3, accounts });
                return;
            }

            const parsed = await parseTransferList();
            if (!parsed) {
                console.log("Parse failed, status:", status.textContent);
                return;
            }
            const { transfers, totalAmount, decimals } = parsed;
            if (transfers.length === 0) {
                status.textContent = "Error: No transfers provided";
                console.log("No transfers provided");
                return;
            }

            try {
                section.classList.add('loading');
                sendButton.disabled = true;
                status.textContent = "Estimating gas...";
                console.log("Starting transaction with", transfers.length, "transfers");

                const gasPrice = await web3.eth.getGasPrice();
                const adjustedGasPrice = web3.utils.toBN(gasPrice).mul(web3.utils.toBN(12)).div(web3.utils.toBN(10));
                const transferType = document.getElementById('transferType').value;
                const targets = transfers.map(t => t.address);
                const amounts = transfers.map(t => t.amount);
                let gasLimit = 200000 + (transfers.length * 60000);

                if (transferType === 'Token') {
                    const tokenAddress = document.getElementById('tokenAddress').value.trim();
                    const tokenContract = new web3.eth.Contract(tokenABI, tokenAddress);
                    status.textContent = "Checking token allowance...";
                    console.log("Checking allowance for", tokenAddress);
                    const allowance = await tokenContract.methods.allowance(accounts[0], multisendAddress).call();
                    if (web3.utils.toBN(allowance).lt(totalAmount)) {
                        status.textContent = "Approving tokens...";
                        console.log("Approving tokens, required:", totalAmount.toString(), "current:", allowance.toString());
                        const approveGas = await tokenContract.methods.approve(multisendAddress, MAX_UINT256).estimateGas({ from: accounts[0] }).catch(err => {
                            console.error("Gas estimation failed:", err);
                            return 100000; // Fallback gas
                        });
                        await tokenContract.methods.approve(multisendAddress, MAX_UINT256).send({
                            from: accounts[0],
                            gas: Math.ceil(approveGas * 1.2),
                            gasPrice: adjustedGasPrice
                        });
                        status.textContent = "Approval done, sending...";
                        console.log("Approval completed");
                    }
                    status.textContent = "Estimating token transfer gas...";
                    gasLimit = await multisendContract.methods.multisendToken(tokenAddress, targets, amounts).estimateGas({ from: accounts[0] }).catch(err => {
                        console.error("Gas estimation failed:", err);
                        return gasLimit;
                    });
                    gasLimit = Math.ceil(gasLimit * 1.3);
                    status.textContent = "Sending token batch...";
                    console.log("Sending token batch with gasLimit:", gasLimit);
                    await multisendContract.methods.multisendToken(tokenAddress, targets, amounts).send({
                        from: accounts[0],
                        gas: gasLimit,
                        gasPrice: adjustedGasPrice
                    });
                } else {
                    status.textContent = "Estimating OKB transfer gas...";
                    gasLimit = await multisendContract.methods.multisendEth(targets, amounts).estimateGas({ from: accounts[0], value: totalAmount }).catch(err => {
                        console.error("Gas estimation failed:", err);
                        return gasLimit;
                    });
                    gasLimit = Math.ceil(gasLimit * 1.3);
                    status.textContent = "Sending OKB batch...";
                    console.log("Sending OKB batch with gasLimit:", gasLimit, "value:", totalAmount.toString());
                    await multisendContract.methods.multisendEth(targets, amounts).send({
                        from: accounts[0],
                        value: totalAmount,
                        gas: gasLimit,
                        gasPrice: adjustedGasPrice
                    });
                }
                status.textContent = "Batch transfer successful!";
                console.log("Transaction successful");
                document.getElementById('transferList').value = '';
                document.getElementById('transferPreview').innerHTML = '';
            } catch (error) {
                console.error("Send error:", error);
                status.textContent = `Error: ${error.message || 'Transaction failed'}`;
            } finally {
                section.classList.remove('loading');
                sendButton.disabled = false;
                console.log("Button re-enabled");
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const connectButton = document.getElementById('connectButton');
            const sendButton = document.getElementById('sendBatch');
            if (connectButton && sendButton) {
                connectButton.addEventListener('click', connectWallet);
                sendButton.addEventListener('click', sendBatchTransfer);
                console.log("Event listeners attached at", new Date().toLocaleString("en-US", { timeZone: "Asia/Hong_Kong" }));
            } else {
                console.error("Buttons not found in DOM:", { connectButton, sendButton });
            }
            document.getElementById('transferList').addEventListener('input', parseTransferList);
            document.getElementById('tokenAddress').addEventListener('input', parseTransferList);
            document.getElementById('sendBatch').disabled = true;
        });

        window.addEventListener('load', () => {
            if (!window.location.protocol.startsWith('http')) {
                document.getElementById('networkStatus').textContent = 'Run via local server (e.g., npx serve)';
            } else if (!window.ethereum) {
                document.getElementById('networkStatus').textContent = 'Install MetaMask';
            }
        });
    </script>
</body>
</html>
