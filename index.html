<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jace Multisend</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400 Weswap.com/explorer/xlayer" target="_blank">X Layer</a> | Jace Multisend Â© 2025
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.0/dist/web3.min.js"></script>
    <script>
        let web3, accounts, multisendContract;
        const multisendContractAddress = "0xa0efAC6b1096a4D2C40BFb2a32dC2AF71a45A9F8";

        const multisendABI = [
            {
                inputs: [
                    { internalType: "address", name: "_token", type: "address" },
                    { internalType: "address[]", name: "_targets", type: "address[]" },
                    { internalType: "uint256[]", name: "_amounts", type: "uint256[]" }
                ],
                name: "multisendToken",
                outputs: [],
                stateMutability: "nonpayable",
                type: "function"
            },
            {
                inputs: [
                    { internalType: "address[]", name: "_targets", type: "address[]" },
                    { internalType: "uint256[]", name: "_amounts", type: "uint256[]" }
                ],
                name: "multisendEth",
                outputs: [],
                stateMutability: "payable",
                type: "function"
            }
        ];

        const tokenABI = [
            {
                inputs: [
                    { internalType: "address", name: "spender", type: "address" },
                    { internalType: "uint256", name: "value", type: "uint256" }
                ],
                name: "approve",
                outputs: [{ internalType: "bool", name: "", type: "bool" }],
                stateMutability: "nonpayable",
                type: "function"
            },
            {
                inputs: [],
                name: "decimals",
                outputs: [{ internalType: "uint8", name: "", type: "uint8" }],
                stateMutability: "view",
                type: "function"
            },
            {
                inputs: [],
                name: "symbol",
                outputs: [{ internalType: "string", name: "", type: "string" }],
                stateMutability: "view",
                type: "function"
            }
        ];

        const xLayer = {
            chainId: 196,
            name: 'X Layer mainnet',
            explorerUrl: 'https://www.okx.com/web3/explorer/xlayer',
            rpcUrl: 'https://rpc.xlayer.tech'
        };

        async function connectWallet() {
            const status = document.getElementById('networkStatus');
            try {
                if (!window.ethereum) {
                    status.innerHTML = 'No wallet detected. Please install <a href="https://metamask.io" target="_blank">MetaMask</a>.';
                    throw new Error("No wallet detected");
                }
                status.innerText = "Connecting...";
                web3 = new Web3(window.ethereum);
                accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                if (!accounts.length) {
                    throw new Error("Please unlock your wallet or connect it.");
                }
                const chainId = await web3.eth.getChainId();
                if (chainId !== 196) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0xc4' }]
                        });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: '0xc4',
                                    chainName: 'X Layer mainnet',
                                    nativeCurrency: { name: 'OKB', symbol: 'OKB', decimals: 18 },
                                    rpcUrls: ['https://rpc.xlayer.tech'],
                                    blockExplorerUrls: ['https://www.okx.com/web3/explorer/xlayer']
                                }]
                            });
                        } else {
                            throw switchError;
                        }
                    }
                }
                document.getElementById('walletAddress').innerText = `${accounts[0].slice(0, 6)}...${accounts[0].slice(-4)}`;
                multisendContract = new web3.eth.Contract(multisendABI, multisendContractAddress);
                status.innerText = "Connected to X Layer";
            } catch (error) {
                console.error(error);
                status.innerText = "Failed to connect: " + error.message;
            }
        }

        function toggleTokenAddressInput() {
            const coinType = document.getElementById('coinType').value;
            const tokenAddressInput = document.getElementById('tokenAddress');
            const coinIcon = document.getElementById('coinIcon');
            tokenAddressInput.style.display = coinType === 'token' ? 'block' : 'none';
            if (coinType === 'OKB') {
                coinIcon.innerHTML = `<img src="https://static.oklink.com/cdn/assets/imgs/243/230501A8E74482AB.png" alt="OKB" style="width: 24px; height: 24px; vertical-align: middle;"> OKB`;
            } else {
                coinIcon.innerHTML = '<span style="display: inline-block; width: 24px; height: 24px; line-height: 24px; text-align: center; background: #00BFA5; color: #121212; border-radius: 50%; font-weight: 600;">T</span> Token';
            }
        }

        async function multisend() {
            const section = document.getElementById('multisendSection');
            const status = document.getElementById('multisendStatus');
            const coinType = document.getElementById('coinType').value;
            const tokenAddress = coinType === 'token' ? document.getElementById('tokenAddress').value.trim() : null;
            const transfersInput = document.getElementById('transfers').value.trim();
            if (coinType === 'token' && (!tokenAddress || !web3.utils.isAddress(tokenAddress))) {
                return alert("Please enter a valid token address!");
            }
            if (!transfersInput) return alert("Please enter recipient addresses and amounts!");
            if (!accounts) return alert("Please connect your wallet first!");

            // Parse transfers
            const lines = transfersInput.split('\n').map(line => line.trim()).filter(line => line);
            const targets = [];
            const amounts = [];
            let decimals = coinType === 'OKB' ? 18 : null;
            try {
                if (coinType === 'token') {
                    const tokenContract = new web3.eth.Contract(tokenABI, tokenAddress);
                    decimals = await tokenContract.methods.decimals().call();
                    const symbol = await tokenContract.methods.symbol().call();
                    document.getElementById('coinIcon').innerHTML = `<span style="display: inline-block; width: 24px; height: 24px; line-height: 24px; text-align: center; background: #00BFA5; color: #121212; border-radius: 50%; font-weight: 600;">${symbol.charAt(0).toUpperCase()}</span> ${symbol}`;
                }
                for (const line of lines) {
                    const [address, amount] = line.split(',').map(item => item.trim());
                    if (!web3.utils.isAddress(address)) throw new Error(`Invalid address: ${address}`);
                    const parsedAmount = parseFloat(amount);
                    if (isNaN(parsedAmount) || parsedAmount <= 0) throw new Error(`Invalid amount for ${address}: ${amount}`);
                    targets.push(address);
                    const amountInWei = web3.utils.toBN(Math.floor(parsedAmount * Math.pow(10, decimals)));
                    amounts.push(amountInWei);
                }
            } catch (error) {
                console.error(error);
                status.innerText = "Error parsing transfers: " + error.message;
                return;
            }

            try {
                section.classList.add('loading');
                status.innerText = `Sending ${coinType === 'OKB' ? 'OKB' : 'tokens'}...`;
                const gasPrice = await web3.eth.getGasPrice();
                const adjustedGasPrice = web3.utils.toBN(gasPrice).mul(web3.utils.toBN(15)).div(web3.utils.toBN(10));
                let tx;
                if (coinType === 'token') {
                    // Approve token spending
                    const tokenContract = new web3.eth.Contract(tokenABI, tokenAddress);
                    const totalAmount = amounts.reduce((sum, amount) => sum.add(amount), web3.utils.toBN(0));
                    await tokenContract.methods.approve(multisendContractAddress, totalAmount).send({
                        from: accounts[0],
                        gas: '100000',
                        gasPrice: adjustedGasPrice
                    });
                    // Multisend tokens
                    tx = await multisendContract.methods.multisendToken(tokenAddress, targets, amounts).send({
                        from: accounts[0],
                        gas: (100000 + targets.length * 50000).toString(),
                        gasPrice: adjustedGasPrice
                    });
                } else {
                    // Multisend OKB
                    const totalAmount = amounts.reduce((sum, amount) => sum.add(amount), web3.utils.toBN(0));
                    tx = await multisendContract.methods.multisendEth(targets, amounts).send({
                        from: accounts[0],
                        value: totalAmount,
                        gas: (100000 + targets.length * 50000).toString(),
                        gasPrice: adjustedGasPrice
                    });
                }
                status.innerHTML = `${coinType === 'OKB' ? 'OKB' : 'Tokens'} sent! Transaction: <a href="${xLayer.explorerUrl}/tx/${tx.transactionHash}" target="_blank">${tx.transactionHash.slice(0, 6)}...${tx.transactionHash.slice(-4)}</a>`;
                document.getElementById('tokenAddress').value = '';
                document.getElementById('transfers').value = '';
            } catch (error) {
                console.error(error);
                status.innerText = `Failed to send ${coinType === 'OKB' ? 'OKB' : 'tokens'}: ` + (error.message.includes('revert') ? error.message.split('revert')[1]?.trim() || 'Unknown reason' : error.message);
            } finally {
                section.classList.remove('loading');
            }
        }

        document.getElementById('connectButton').addEventListener('click', connectWallet);
        document.getElementById('coinType').addEventListener('change', toggleTokenAddressInput);
        document.getElementById('multisendButton').addEventListener('click', multisend);

        window.addEventListener('load', () => {
            if (!window.location.protocol.startsWith('http')) {
                document.getElementById('networkStatus').innerHTML = 'Please run this page via a local server (e.g., "npx serve") to connect MetaMask.';
            } else if (!window.ethereum) {
                document.getElementById('networkStatus').innerHTML = 'No wallet detected. Please install <a href="https://metamask.io">MetaMask</a>.';
            }
            toggleTokenAddressInput();
        });
    </script>
</body>
</html>
